import MapData from '../models/MapData.js'; import { queryGEEPoint } from '../utils/geeService.js';
export const getMapData = async (req,res)=>{ try{ const {latitude,longitude}=req.body; if(latitude===undefined||longitude===undefined) return res.status(400).json({error:'Missing coords'}); let data=null; if(process.env.USE_GEE==='true'){ const gee=await queryGEEPoint(latitude,longitude); if(gee) data={location:{latitude,longitude},soil:{pH:null,fertility:null,nitrogen:null},moisture:{value:gee.moisture.value,status:gee.moisture.value>=0.35?'optimal':'low'},flood_risk:gee.flood_risk,gee_meta:gee}; } if(!data){ data={location:{latitude,longitude},soil:{pH:parseFloat((Math.random()*(7.5-5.5)+5.5).toFixed(2)),fertility:['low','medium','high'][Math.floor(Math.random()*3)],nitrogen:parseFloat((Math.random()*(80-20)+20).toFixed(2))},moisture:{value:parseFloat((Math.random()*(0.8-0.2)+0.2).toFixed(2)),status:['low','moderate','optimal'][Math.floor(Math.random()*3)]},flood_risk:['low','medium','high'][Math.floor(Math.random()*3)]}; } const doc=await MapData.create(data); res.json(doc); }catch(e){console.error(e);res.status(500).json({error:'Server'})} };
